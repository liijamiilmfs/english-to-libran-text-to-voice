# Batch Renderer CLI - Issue #32

The Batch Renderer is a command-line tool that processes text files, splits them into segments based on headings, generates audio for each segment using the Librán TTS system, and optionally stitches them together with a cue sheet.

## Features

- **Text Parsing**: Automatically detects headings in various formats (Markdown, plain text)
- **Batch Audio Generation**: Uses the existing TTS API to generate audio for each segment
- **Audio Stitching**: Combines multiple audio files into a single file
- **Cue Sheet Generation**: Creates CUE format files with timing information
- **Flexible Options**: Supports different voices, formats, and translation variants

## Usage

```bash
npm run batch-render <input-file> [options]
```

### Options

- `--output, -o`: Output directory (default: `./output`)
- `--voice, -v`: Voice to use (default: `alloy`)
  - Available voices: `alloy`, `echo`, `fable`, `onyx`, `nova`, `shimmer`
- `--format, -f`: Audio format (default: `mp3`)
  - Supported formats: `mp3`, `wav`, `flac`
- `--variant, -r`: Translation variant (default: `modern`)
  - Options: `ancient`, `modern`
- `--no-stitch`: Skip audio stitching (individual files only)
- `--no-cue`: Skip cue sheet generation
- `--help, -h`: Show help information

### Examples

```bash
# Basic usage
npm run batch-render story.txt

# Custom voice and variant
npm run batch-render story.txt --voice nova --variant ancient

# Custom output directory
npm run batch-render story.txt --output ./audio

# Individual files only (no stitching)
npm run batch-render story.txt --no-stitch

# No cue sheet
npm run batch-render story.txt --no-cue
```

## Text Format Support

The batch renderer automatically detects headings in the following formats:

### Markdown Style
```markdown
# Main Title
## Chapter 1: The Beginning
### Section 1.1
```

### Plain Text
```text
=== MAIN TITLE ===
--- Chapter 1: The Beginning ---
SECTION 1.1
```

### All Caps Short Lines
```text
CHAPTER ONE
THE BEGINNING
```

## Output Files

For a file named `story.txt`, the batch renderer generates:

- `segment_001_Title.mp3` - Individual audio segments
- `segment_002_Chapter_1.mp3`
- `segment_003_Chapter_2.mp3`
- `story_stitched.mp3` - Combined audio file (if stitching enabled)
- `story.cue` - Cue sheet with timing information

## Cue Sheet Format

The generated cue sheet follows the standard CUE format:

```
REM Generated by Librán Voice Forge Batch Renderer
REM Date: 2025-09-22T23:55:59.695Z
REM Total segments: 5

FILE "story_stitched.mp3" MP3

TRACK 01 AUDIO
  TITLE "Chapter 1: The Beginning"
  INDEX 01 00:00:00

TRACK 02 AUDIO
  TITLE "Chapter 2: The Discovery"
  INDEX 01 00:01:45
```

## Requirements

- Node.js 20.17.0 or higher
- Development server running (`npm run dev`)
- OpenAI API key configured
- Text file with content to process

## Technical Details

### Text Parsing Algorithm

1. Reads the input file line by line
2. Detects headings using multiple patterns:
   - Markdown headers (`#`, `##`, `###`)
   - Plain text headers (`===`, `---`)
   - All-caps short lines without periods
3. Groups content under each heading
4. Falls back to single segment if no headings found

### Audio Generation

1. Calls the `/api/translate` endpoint for each segment
2. Calls the `/api/speak` endpoint with the translated text
3. Saves individual audio files
4. Optionally stitches files together using simple concatenation

### Timing Estimation

- Estimates duration based on word count (150 words per minute)
- Generates cue sheet with calculated timestamps
- Uses CD audio format (75 frames per second)

## Error Handling

- Validates input file existence
- Handles API failures gracefully
- Provides detailed error messages
- Continues processing remaining segments on individual failures

## Future Enhancements

- [ ] Support for more audio formats
- [ ] Advanced audio stitching with proper timing
- [ ] Support for custom heading patterns
- [ ] Parallel audio generation for faster processing
- [ ] Integration with external audio tools (ffmpeg)
- [ ] Support for metadata and tags
- [ ] Progress bars and better user feedback
